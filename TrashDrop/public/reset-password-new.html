<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#198754">
    <meta name="description" content="Reset your TrashDrop account password">
    <title>Reset Password - TrashDrop</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #198754;
            --primary-hover: #157347;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #198754;
            --border-radius: 0.5rem;
            --box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--light-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .reset-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 420px;
            margin: 2rem auto;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .logo img {
            max-width: 180px;
            height: auto;
        }
        
        .form-title {
            color: var(--dark-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.15);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            width: 100%;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:disabled {
            background-color: #a3cfbb;
            transform: none;
            box-shadow: none;
        }
        
        .alert {
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        
        .password-strength {
            margin: 0.5rem 0;
        }
        
        .password-strength-meter {
            height: 5px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .password-requirements {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .password-requirements li {
            margin-bottom: 0.25rem;
            position: relative;
        }
        
        .password-requirements li.valid {
            color: var(--success-color);
        }
        
        .password-requirements li.valid::before {
            content: 'âœ“';
            position: absolute;
            left: -1.25rem;
            color: var(--success-color);
        }
        
        .back-to-login {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .back-to-login a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .back-to-login a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }
        
        #loadingIndicator {
            display: none;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            padding: 1rem;
            background-color: rgba(248, 249, 250, 0.8);
            border-radius: var(--border-radius);
        }
        
        .spinner-border {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            border-width: 0.15em;
        }
        
        .form-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .form-step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 576px) {
            .reset-container {
                padding: 1.5rem;
                margin: 1rem auto;
            }
            
            .logo img {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="reset-container">
            <div class="logo">
                <img src="/images/trashdrop-logo.png" alt="TrashDrop Logo" class="img-fluid">
            </div>
            
            <h1 class="form-title">Reset Your Password</h1>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Processing your request...</span>
            </div>
            
            <!-- Messages -->
            <div id="message" class="alert d-none" role="alert"></div>
            
            <!-- Step 1: Email Form -->
            <div id="emailForm" class="form-step active">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Enter your email address and we'll send you a link to reset your password.
                </div>
                
                <form id="resetForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control form-control-lg" id="email" name="email" 
                               placeholder="your@email.com" required autocomplete="email">
                        <div class="invalid-feedback">Please enter a valid email address</div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <span id="buttonText">Send Reset Link</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Step 2: Password Reset Form -->
            <div id="passwordForm" class="form-step">
                <div class="alert alert-info">
                    <i class="bi bi-shield-lock-fill me-2"></i>
                    Create a new password for your account.
                </div>
                
                <form id="resetPasswordForm">
                    <div class="mb-3">
                        <label for="password" class="form-label">New Password</label>
                        <input type="password" class="form-control form-control-lg" id="password" name="password" 
                               required autocomplete="new-password" minlength="8">
                        <div class="password-requirements mt-2">
                            <div class="password-strength">
                                <div class="progress" style="height: 5px;">
                                    <div id="passwordStrengthMeter" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <ul class="list-unstyled mt-2">
                                <li id="req-length">At least 8 characters</li>
                                <li id="req-uppercase">At least 1 uppercase letter</li>
                                <li id="req-number">At least 1 number</li>
                                <li id="req-special">At least 1 special character</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control form-control-lg" id="confirmPassword" 
                               name="confirmPassword" required autocomplete="new-password">
                        <div class="invalid-feedback" id="passwordMatchError">
                            Passwords do not match
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="resetBtn">
                            <span id="resetButtonText">Reset Password</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Step 3: Success Message -->
            <div id="successMessage" class="form-step text-center py-4">
                <div class="mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="var(--success-color)" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                    </svg>
                </div>
                <h3 class="mb-3">Password Reset Successful!</h3>
                <p class="mb-4">Your password has been successfully updated. You can now log in with your new password.</p>
                <a href="/auth-standalone.html" class="btn btn-primary">Back to Login</a>
            </div>
            
            <div class="back-to-login">
                Remember your password? <a href="/auth-standalone.html">Log in</a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Password Reset Script -->
    <script>
        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://cpeyavpxqcloupolbvyh.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZXlhdnB4cWNsb3Vwb2xidnloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0OTY4OTYsImV4cCI6MjA2MTA3Mjg5Nn0.5rxsiRuLHCpeJZ5TqoIA5X4UwoAAuxIpNu_reafwwbQ',
            REDIRECT_URL: window.location.origin + '/reset-password-continuation.html',
            PASSWORD_REQUIREMENTS: {
                minLength: 8,
                hasUppercase: /[A-Z]/,
                hasNumber: /\d/,
                hasSpecial: /[!@#$%^&*(),.?":{}|<>]/
            }
        };

        // State
        const state = {
            supabase: null,
            accessToken: null,
            email: null,
            isInitialized: false
        };

        // DOM Elements
        const elements = {
            emailInput: null,
            passwordInput: null,
            confirmPasswordInput: null,
            resetForm: null,
            resetPasswordForm: null,
            messageDiv: null,
            loadingIndicator: null,
            passwordStrengthMeter: null,
            emailForm: null,
            passwordForm: null,
            successMessage: null,
            submitButton: null,
            resetButton: null
        };

        // Function to check for access token in URL or storage
        async function checkForAccessToken() {
            console.log('Checking for access token...');
            
            // First check URL parameters for auth code (PKCE flow)
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('Auth error in URL:', error, urlParams.get('error_description'));
                showError('Authentication error. Please try again.');
                showStep('emailForm');
                return false;
            }
            
            // Check URL hash for tokens (implicit flow)
            const hash = window.location.hash.substring(1);
            if (hash) {
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const refreshToken = params.get('refresh_token');
                const type = params.get('type');
                
                if (accessToken && type === 'recovery') {
                    console.log('Found recovery token in URL hash');
                    
                    // Store tokens in localStorage for Supabase to use
                    if (refreshToken) {
                        localStorage.setItem('sb-auth-token', JSON.stringify({
                            access_token: accessToken,
                            refresh_token: refreshToken,
                            token_type: 'bearer',
                            expires_in: 3600,
                            expires_at: Math.floor(Date.now() / 1000) + 3600
                        }));
                        
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Show password reset form
                        showStep('passwordForm');
                        return true;
                    }
                }
            }
            
            // If we have an auth code, exchange it for a session
            if (authCode) {
                console.log('Found auth code in URL, exchanging for session...');
                try {
                    setLoading(true);
                    
                    // Exchange the auth code for a session
                    const { data, error } = await state.supabase.auth.exchangeCodeForSession(authCode);
                    
                    if (error) throw error;
                    
                    console.log('Successfully exchanged code for session');
                    
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Show password reset form
                    showStep('passwordForm');
                    return true;
                    
                } catch (error) {
                    console.error('Error exchanging auth code:', error);
                    showError('Failed to verify your session. Please try again.');
                    showStep('emailForm');
                    return false;
                } finally {
                    setLoading(false);
                }
            }
            
            // Check if we already have a valid session
            const { data: { session } } = await state.supabase.auth.getSession();
            if (session) {
                console.log('Found existing session');
                state.accessToken = session.access_token;
                showStep('passwordForm');
                return true;
            }
            
            console.log('No access token found, showing email form');
            showStep('emailForm');
            return false;
        }

        // Function to show error messages
        function showError(message) {
            console.error('Error:', message);
            
            if (elements.messageDiv) {
                elements.messageDiv.textContent = message;
                elements.messageDiv.className = 'alert alert-danger';
                elements.messageDiv.style.display = 'block';
                
                // Scroll to message
                elements.messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (elements.messageDiv) {
                        elements.messageDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // Function to show success messages
        function showSuccess(message) {
            console.log('Success:', message);
            
            if (elements.messageDiv) {
                elements.messageDiv.textContent = message;
                elements.messageDiv.className = 'alert alert-success';
                elements.messageDiv.style.display = 'block';
                
                // Scroll to message
                elements.messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (elements.messageDiv) {
                        elements.messageDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // Function to show a specific step
        function showStep(stepId) {
            console.log('Showing step:', stepId);
            
            // Hide all steps
            if (elements.emailForm) elements.emailForm.classList.remove('active');
            if (elements.passwordForm) elements.passwordForm.classList.remove('active');
            if (elements.successMessage) elements.successMessage.classList.remove('active');
            
            // Show the requested step
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
                
                // Focus the first input in the step
                const firstInput = stepElement.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        // Initialize the password reset functionality when the DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing password reset...');
            
            try {
                // Initialize Supabase client first
                await initializeSupabase();
                
                // Initialize DOM elements
                initializeElements();
                
                // Check for access token in URL or storage
                const hasToken = await checkForAccessToken();
                
                // If no token found, check URL for auth code
                if (!hasToken) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    
                    if (code) {
                        console.log('Found auth code in URL, attempting to verify...');
                        try {
                            setLoading(true);
                            
                            // Exchange the code for a session
                            const { data, error } = await state.supabase.auth.exchangeCodeForSession(code);
                            
                            if (error) throw error;
                            
                            console.log('Successfully verified reset link');
                            
                            // Clean up the URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                            
                            // Show the password form
                            showStep('passwordForm');
                            
                            // Setup event listeners
                            setupEventListeners();
                            state.isInitialized = true;
                            return;
                            
                        } catch (error) {
                            console.error('Error verifying reset link:', error);
                            showError('Invalid or expired reset link. Please request a new one.');
                        } finally {
                            setLoading(false);
                        }
                    }
                }
                
                // If we get here, either we have a token or need to show the email form
                if (hasToken) {
                    showStep('passwordForm');
                } else {
                    showStep('emailForm');
                }
                
                // Setup event listeners
                setupEventListeners();
                
                // Mark as initialized
                state.isInitialized = true;
                
                console.log('Password reset initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize password reset. Please refresh the page and try again.');
            }
        });

        // Initialize Supabase client
        async function initializeSupabase() {
            console.log('Initializing Supabase client...');
            
            // Create Supabase client with proper auth configuration for password reset
            state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY, {
                auth: {
                    autoRefreshToken: false,
                    persistSession: false,
                    detectSessionInUrl: true,
                    flowType: 'pkce',
                    storage: window.localStorage,
                    storageKey: 'sb-auth-token',
                    debug: true,
                    // Set the site URL to ensure proper redirects
                    siteUrl: window.location.origin,
                    // Disable auto token refresh to prevent issues
                    autoRefreshToken: false,
                    // Ensure we're using the correct redirect URL
                    redirectTo: window.location.origin + '/reset-password-continuation.html',
                    // Add headers for better compatibility
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    // Explicitly set the auth URL
                    auth: {
                        autoConfirm: true,
                        detectSessionInUrl: true,
                        flowType: 'pkce',
                        redirectTo: window.location.origin + '/reset-password-continuation.html'
                    }
                }
            });
            
            // Set up auth state change listener
            state.supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event, session);
                
                if (event === 'PASSWORD_RECOVERY') {
                    console.log('Password recovery in progress');
                    // Show the password form when recovery is detected
                    showStep('passwordForm');
                } else if (event === 'SIGNED_IN') {
                    console.log('User signed in');
                    // If user signs in during recovery, we don't need to do anything special
                }
                
                // If we have a session, store the access token
                if (session) {
                    state.accessToken = session.access_token;
                }
            });
            
            console.log('Supabase client initialized');
        }

        // Initialize DOM elements
        function initializeElements() {
            console.log('Initializing DOM elements...');
            
            // Form elements
            elements.resetForm = document.getElementById('resetForm');
            elements.resetPasswordForm = document.getElementById('resetPasswordForm');
            elements.emailInput = document.getElementById('email');
            elements.passwordInput = document.getElementById('password');
            elements.confirmPasswordInput = document.getElementById('confirmPassword');
            elements.messageDiv = document.getElementById('message');
            elements.loadingIndicator = document.getElementById('loadingIndicator');
            elements.passwordStrengthMeter = document.getElementById('passwordStrengthMeter');
            elements.emailForm = document.getElementById('emailForm');
            elements.passwordForm = document.getElementById('passwordForm');
            elements.successMessage = document.getElementById('successMessage');
            
            // Buttons
            elements.submitButton = document.querySelector('button[type="submit"]');
            elements.resetButton = document.getElementById('resetBtn');
            
            console.log('DOM elements initialized:', elements);
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Form submission
            if (elements.resetForm) {
                elements.resetForm.addEventListener('submit', handleFormSubmit);
                console.log('Added form submit listener for reset form');
            }
            
            if (elements.resetPasswordForm) {
                elements.resetPasswordForm.addEventListener('submit', handleFormSubmit);
                console.log('Added form submit listener for password form');
            }
            
            // Password strength meter
            if (elements.passwordInput) {
                elements.passwordInput.addEventListener('input', updatePasswordStrength);
                console.log('Added password strength listener');
            }
            
            // Enter key in password fields
            if (elements.passwordInput) {
                elements.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleFormSubmit(e);
                    }
                });
            }
            
            if (elements.confirmPasswordInput) {
                elements.confirmPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleFormSubmit(e);
                    }
                });
            }
            
            console.log('Event listeners set up');
        }

        // Update password strength meter and validation
        function updatePasswordStrength() {
            const password = elements.passwordInput.value;
            const strengthMeter = document.getElementById('password-strength-meter');
            const strengthText = document.getElementById('password-strength-text');
            const requirements = document.getElementById('password-requirements');
            
            if (!password) {
                if (strengthMeter) strengthMeter.style.width = '0%';
                if (strengthText) strengthText.textContent = '';
                if (requirements) requirements.classList.remove('show');
                return;
            }
            
            // Check password requirements
            const hasMinLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            // Calculate strength score (0-100)
            let strength = 0;
            if (password.length >= 12) strength += 40; // Length bonus for longer passwords
            if (hasUppercase) strength += 15;
            if (hasLowercase) strength += 15;
            if (hasNumber) strength += 15;
            if (hasSpecial) strength += 15;
            
            // Cap at 100%
            strength = Math.min(100, strength);
            
            // Update strength meter
            if (strengthMeter) {
                strengthMeter.style.width = `${strength}%`;
                
                // Set color based on strength
                if (strength < 40) {
                    strengthMeter.classList.remove('bg-warning', 'bg-success');
                    strengthMeter.classList.add('bg-danger');
                    if (strengthText) strengthText.textContent = 'Weak';
                } else if (strength < 70) {
                    strengthMeter.classList.remove('bg-danger', 'bg-success');
                    strengthMeter.classList.add('bg-warning');
                    if (strengthText) strengthText.textContent = 'Moderate';
                } else {
                    strengthMeter.classList.remove('bg-danger', 'bg-warning');
                    strengthMeter.classList.add('bg-success');
                    if (strengthText) strengthText.textContent = 'Strong';
                }
            }
            
            // Update requirements list
            if (requirements) {
                requirements.classList.add('show');
                const items = requirements.querySelectorAll('li');
                
                items[0].className = hasMinLength ? 'text-success' : '';
                items[1].className = hasUppercase ? 'text-success' : '';
                items[2].className = hasNumber ? 'text-success' : '';
                items[3].className = hasSpecial ? 'text-success' : '';
                
                // Add/remove checkmark icons
                items.forEach((item, index) => {
                    const icon = item.querySelector('i');
                    if (icon) {
                        const isValid = [hasMinLength, hasUppercase, hasNumber, hasSpecial][index];
                        icon.className = `bi ${isValid ? 'bi-check-circle-fill text-success' : 'bi-dash-circle'}`;
                    }
                });
            }
            
            // Validate passwords match if confirm password is filled
            if (elements.confirmPasswordInput && elements.confirmPasswordInput.value) {
                validatePasswordMatch();
            }
        }
        
        // Validate password match
        function validatePasswordMatch() {
            const password = elements.passwordInput.value;
            const confirmPassword = elements.confirmPasswordInput.value;
            const matchMessage = document.getElementById('password-match-message');
            
            if (!password || !confirmPassword) {
                if (matchMessage) matchMessage.style.display = 'none';
                return true;
            }
            
            const passwordsMatch = password === confirmPassword;
            
            if (matchMessage) {
                matchMessage.style.display = 'block';
                matchMessage.className = passwordsMatch ? 'text-success' : 'text-danger';
                matchMessage.innerHTML = passwordsMatch 
                    ? '<i class="bi bi-check-circle-fill"></i> Passwords match' 
                    : '<i class="bi bi-exclamation-triangle-fill"></i> Passwords do not match';
            }
            
            return passwordsMatch;
        }

        // Set loading state for form submissions
        function setLoading(isLoading) {
            console.log('Setting loading state:', isLoading);
            
            // Update submit button state
            if (elements.submitButton) {
                elements.submitButton.disabled = isLoading;
                
                if (isLoading) {
                    // Store original button text
                    elements.submitButton.setAttribute('data-original-text', elements.submitButton.textContent);
                    elements.submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                } else {
                    // Restore original button text
                    const originalText = elements.submitButton.getAttribute('data-original-text') || 'Submit';
                    elements.submitButton.textContent = originalText;
                }
            }
            
            // Update reset button state if it exists
            if (elements.resetButton) {
                elements.resetButton.disabled = isLoading;
            }
            
            // Toggle loading indicator
            if (elements.loadingIndicator) {
                elements.loadingIndicator.style.display = isLoading ? 'block' : 'none';
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            
            // Check which step we're on
            if (email) {
                await handleForgotPassword(email);
            } else if (password && confirmPassword) {
                await handleResetPassword(password, confirmPassword);
            }
        }

        // Handle forgot password request
        async function handleForgotPassword(email) {
            console.log('Handling forgot password for:', email);
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            try {
                setLoading(true);
                
                // Create the full URL to the reset password continuation page
                const resetPasswordUrl = new URL('http://127.0.0.1:3000/reset-password-continuation.html');
                
                // Add email as a query parameter (no need to double-encode)
                resetPasswordUrl.searchParams.set('email', email);
                
                // Add a timestamp to prevent caching issues
                resetPasswordUrl.searchParams.set('t', Date.now());
                
                // Create the full redirect URL with the reset password page
                const fullRedirectUrl = resetPasswordUrl.toString();
                console.log('Sending password reset email with redirect URL:', fullRedirectUrl);
                
                // Use the correct method to send password reset email
                const { data, error } = await state.supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: fullRedirectUrl,
                    // Add any additional options if needed by your Supabase version
                });
                
                console.log('Password reset email response:', { data, error });
                
                if (error) throw error;
                
                showSuccess('Password reset link sent! Please check your email.');
                console.log('Password reset email sent to:', email);
                
                // Store email for next step
                state.email = email;
                
            } catch (error) {
                console.error('Error sending reset email:', error);
                
                let errorMessage = 'Failed to send reset link. Please try again.';
                if (error.message.includes('user not found')) {
                    errorMessage = 'No account found with this email address.';
                } else if (error.message.includes('rate limit')) {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else if (error.message.includes('email not confirmed')) {
                    errorMessage = 'Please verify your email address before resetting your password.';
                }
                
                showError(errorMessage);
            } finally {
                setLoading(false);
            }
        }

        // Handle password reset
        async function handleResetPassword(password, confirmPassword) {
            console.log('Handling password reset');
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return false;
            }
            
            // Validate password meets requirements
            if (!validatePassword(password)) {
                showError('Password does not meet all requirements');
                return false;
            }
            
            try {
                setLoading(true);
                
                // Update the password using the current session
                const { data, error } = await state.supabase.auth.updateUser({
                    password: password
                });
                
                if (error) throw error;
                
                console.log('Password updated successfully');
                showSuccess('Your password has been reset successfully!');
                showStep('successMessage');
                
                // Sign out after successful password reset
                await state.supabase.auth.signOut();
                
                // Redirect to login after a short delay
                setTimeout(() => {
                    window.location.href = '/auth-standalone.html';
                }, 3000);
                
                return true;
                
            } catch (error) {
                console.error('Error resetting password:', error);
                
                let errorMessage = 'Failed to reset password. Please try again.';
                if (error.message.includes('session expired') || error.message.includes('invalid token')) {
                    errorMessage = 'The password reset link has expired or is invalid. Please request a new one.';
                } else if (error.message.includes('weak password')) {
                    errorMessage = 'Please choose a stronger password. The password should be at least 8 characters long and include a mix of letters, numbers, and special characters.';
                } else if (error.message.includes('Auth session missing')) {
                    errorMessage = 'Your session has expired. Please request a new password reset link.';
                }
                
                showError(errorMessage);
                return false;
            } finally {
                setLoading(false);
            }
        }
        
        // Handle back to login button
        const backToLoginBtn = document.querySelector('.back-to-login a');
        if (backToLoginBtn) {
            backToLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = '/login.html';
            });
        }
    </script>
</body>
</html>
